# Example: Using a PVC as a Kopia filesystem repository
# This demonstrates the moverVolumes pattern for local/network storage backups
---
# Namespace for the example
apiVersion: v1
kind: Namespace
metadata:
  name: filesystem-backup-example
---
# Source PVC containing data to backup
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: application-data
  namespace: filesystem-backup-example
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi
---
# PVC to use as the backup repository
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: backup-repository
  namespace: filesystem-backup-example
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 50Gi
  # Optional: Use specific storage class for backup storage
  # storageClassName: fast-ssd
---
# Secret with repository password
# Note: KOPIA_REPOSITORY is automatically detected from moverVolumes
apiVersion: v1
kind: Secret
metadata:
  name: kopia-config
  namespace: filesystem-backup-example
type: Opaque
stringData:
  # Password for repository encryption (required)
  KOPIA_PASSWORD: "change-this-to-a-secure-password-minimum-16-chars"
  # Optional: Explicitly specify filesystem repository type for clarity
  # When moverVolumes is set, VolSync automatically detects the repository from the first PVC
  # KOPIA_REPOSITORY: "filesystem:"
---
# ReplicationSource for scheduled backups to filesystem
apiVersion: volsync.backube/v1alpha1
kind: ReplicationSource
metadata:
  name: filesystem-backup
  namespace: filesystem-backup-example
spec:
  # Source PVC to backup
  sourcePVC: application-data

  # Backup schedule
  trigger:
    schedule: "0 */6 * * *"  # Every 6 hours

  # Kopia configuration with moverVolumes
  kopia:
    # Reference to the repository configuration secret
    repository: kopia-config

    # Mount PVC for filesystem repository using moverVolumes
    # Repository will be accessed at /mnt/kopia-repo
    moverVolumes:
    - mountPath: kopia-repo
      volumeSource:
        persistentVolumeClaim:
          claimName: backup-repository

    # Optional: Retention policy
    retain:
      hourly: 24
      daily: 7
      weekly: 4
      monthly: 3
      yearly: 1
      latest: 50  # Keep N most recent snapshots (useful for high-frequency backups)

    # Optional: Compression algorithm (zstd, gzip, s2, none)
    compression: "zstd"

    # Optional: Number of parallel upload streams
    parallelism: 4

    # Optional: Cache configuration
    cacheCapacity: 2Gi
---
# Example: NFS-backed repository for shared storage
apiVersion: v1
kind: PersistentVolume
metadata:
  name: nfs-backup-pv
spec:
  capacity:
    storage: 500Gi
  accessModes:
    - ReadWriteMany
  nfs:
    server: nfs-server.example.com
    path: /exports/volsync-backups
  persistentVolumeReclaimPolicy: Retain
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: nfs-backup-repository
  namespace: filesystem-backup-example
spec:
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: 500Gi
  volumeName: nfs-backup-pv
---
# Example: Using NFS storage for backups with moverVolumes
apiVersion: volsync.backube/v1alpha1
kind: ReplicationSource
metadata:
  name: nfs-backup
  namespace: filesystem-backup-example
spec:
  sourcePVC: application-data
  trigger:
    schedule: "0 2 * * *"  # Daily at 2 AM
  kopia:
    repository: kopia-config
    # Mount NFS-backed PVC using moverVolumes pattern
    # Repository will be at /mnt/repository
    moverVolumes:
    - mountPath: repository
      volumeSource:
        persistentVolumeClaim:
          claimName: nfs-backup-repository
    retain:
      daily: 30
      weekly: 12
      monthly: 6
    compression: "zstd"
---
# Example: Restore from filesystem repository
# IMPORTANT: Kopia ReplicationDestination REQUIRES identity configuration
apiVersion: volsync.backube/v1alpha1
kind: ReplicationDestination
metadata:
  name: filesystem-restore
  namespace: filesystem-backup-example
spec:
  trigger:
    manual: restore-trigger

  kopia:
    # Repository configuration must include proper repository URL
    # For restore, create a secret with the filesystem URL
    repository: kopia-restore-config

    # Destination PVC for restored data
    destinationPVC: restored-data
    copyMethod: Direct

    # Identity configuration:
    # If this restore is in SAME namespace with SAME name as source:
    #    NO identity configuration needed! (fully automatic)
    # If cross-namespace OR different name: sourceIdentity REQUIRED
    sourceIdentity:
      sourceName: filesystem-backup        # Name of the ReplicationSource (REQUIRED)
      sourceNamespace: filesystem-backup-example  # Source namespace (REQUIRED)
      # sourcePVCName is auto-discovered from source ReplicationSource

    # Alternative: Use explicit username and hostname (both required)
    # Only use when source had custom username/hostname
    # username: "filesystem-backup"
    # hostname: "filesystem-backup-example"  # Always just namespace
---
# Secret for restore operations
# Must specify the filesystem URL explicitly for ReplicationDestination
apiVersion: v1
kind: Secret
metadata:
  name: kopia-restore-config
  namespace: filesystem-backup-example
type: Opaque
stringData:
  # For restore, must specify the full filesystem URL
  # This should match the mount path used in the source moverVolumes
  KOPIA_REPOSITORY: "filesystem:///mnt/kopia-repo"
  KOPIA_PASSWORD: "change-this-to-a-secure-password-minimum-16-chars"
---
# Destination PVC for restored data
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: restored-data
  namespace: filesystem-backup-example
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi
---
# Benefits of the moverVolumes pattern:
#
# 1. **Consistency**: Same pattern across all movers (restic, rclone, rsync-tls, syncthing, kopia)
# 2. **Flexibility**: Standard volume mounting with explicit paths at /mnt/<mountPath>
# 3. **Clear Intent**: Descriptive mount paths make purpose obvious
# 4. **Standard Pattern**: Familiar to users of other VolSync movers
# 5. **Kubernetes Native**: Uses standard Kubernetes volume source types
#
# Migration from old repositoryPVC API:
# OLD (removed in v0.11.0):
#   kopia:
#     repositoryPVC: backup-storage-pvc
#
# NEW (v0.11.0+):
#   kopia:
#     moverVolumes:
#     - mountPath: kopia-repo
#       volumeSource:
#         persistentVolumeClaim:
#           claimName: backup-storage-pvc
